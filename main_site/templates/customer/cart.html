{% extends "base/base.html" %}
{% block style %}{% endblock style %}
{% block content %}
<table >
    <tr>
        <th>Ordinal</th>
        <th>Image</th>
        <th>Name</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Total</th>
        <th >Action</th>
    </tr>
    {% for cart in carts %}
    <tr id="ContentContainer{{cart.cart.product.id}}" >
        <td>{{forloop.counter}}</td>
        <td> 
            <img src="{{cart.image.image.url}}" alt="{{cart.cart.product.name}}" style="width: 100px; height: 100px;" />     
        </td>
        <td>{{cart.cart.product.name}}</td>
        <td>
            <span class="quantity" data-product-id="{{ cart.cart.id }}">{{cart.cart.set_quantity}}</span>
            <button onclick="update_quantity({{ cart.cart.id }}, 1)">+</button>
            <button onclick="update_quantity({{ cart.cart.id }}, -1)">-</button>
            <div id="error-{{cart.cart.id}}" style="color: red; display: none;"></div>
        </td>
        <td>{{cart.cart.product.get_price_formatted}}</td>
        <td>{{cart.cart.get_total_formatted}}</td>
        <td >
            <button type="button" onclick="remove({{user.id}},{{cart.cart.product.id}})">Remove</button>
        </td>
    </tr>
    {% endfor %}
</table>
<a href="{% url "get_payment" user.id %}">Payment</a>
{% endblock content %}
{% block script %}
<script >
function update_quantity(cart_id, change) {
    const quantityElement = document.querySelector(`span.quantity[data-product-id="${cart_id}"]`);
    const errorElement = document.getElementById(`error-${cart_id}`);
    errorElement.style.display = 'none';
    errorElement.textContent = '';

    fetch(`/update_quantity/cart/${cart_id}/${change}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),  // Lấy CSRF token từ cookie
        },
    })
    .then(response => {
        if (response.status === 400) {
            throw new Error("Limit quantity!");
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            quantityElement.textContent = data.new_quantity;
        } else {
            errorElement.textContent = data.error || 'Error updating quantity';
            errorElement.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        errorElement.textContent = error.message;
        errorElement.style.display = 'block';
    });
}

function remove(user_id, product_id){
    const content_container_id = `ContentContainer${product_id}`;
    const content_container = document.getElementById(content_container_id);
    if (confirm("Do you want to remove this product from this list")){
        fetch(`/delete_cart/${user_id}/${product_id}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
        }).then(response => {
            if (!response.ok){
                throw new Error(`HTTP error with status: ${response.status}`);
            }
            return response.json();
        }).then(data => {
            alert(data.message);
            if (!data.success){
                return;
            }
            content_container.style.display = 'none';
        })
    }
}
</script>
{% endblock script %}